name: deploy-podinfo
"on":
  workflow_dispatch:
    inputs:
      destination-group:
        description: the destination group to deploy (mutually exclusive with destination, default "-" for all groups)
        required: false
        type: choice
        options:
        - "-"
        - mock-staging
        - mock-prod
      destination:
        description: the destination to deploy (mutually exclusive with destination-group, default "-" for all destinations)
        required: false
        type: choice
        options:
          - "-"
          - '{"group":"mock-prod","cluster":"in-cluster"}'
          - '{"group":"mock-staging","cluster":"in-cluster"}'
      revision-to-deploy:
        description: the revision to deploy
        required: true
        type: choice
        options:
        - "-"
        - "abc123"
        - "def456"
  push:
    paths:
    - .alveus/demo/manifests
    branches:
    - main

defaults:
  run:
    shell: bash
jobs:
  single:
    if: ${{ inputs.destination != '-' && inputs.destination-group == '-' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false
        ref: "${{ inputs.revision-to-deploy }}"
    - name: input-jq
      id: input-jq
      run:
        echo "group=${{ fromJSON(inputs.destination).group }}" >> $GITHUB_OUTPUT
        echo "cluster=${{ fromJSON(inputs.destination).cluster }}" >> $GITHUB_OUTPUT
    - uses: ./.github/actions/alveus-deploy
      with:
        target-revision: ${{ github.sha }}
        application-file: "./.alveus/applications/podinfo-${{ steps.input-jq.outputs.group }}-${{ steps.input-jq.outputs.cluster }}.yaml"
        git-commit-msg: |
          deploy(${{ steps.input-jq.outputs.group }}): ðŸš€ to ${{ steps.input-jq.outputs.cluster }}

  mock-staging:
    if:  ${{ inputs.destination == '-' && ( inputs.destination-group == '-' || inputs.destination-group == 'mock-staging' ) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        group: [mock-staging]
        dest: [in-cluster]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: "${{ inputs.revision-to-deploy }}"
      - uses: ./.github/actions/alveus-deploy
        with:
          target-revision: ${{ github.sha }}
          application-file: "./.alveus/applications/podinfo-${{ matrix.group }}-${{ matrix.dest }}.yaml"
          git-commit-msg: |
            deploy(${{ matrix.group }}): ðŸš€ to ${{ matrix.dest }}

  mock-prod:
    if: ${{ inputs.destination == '-' && ( inputs.destination-group == '-' || inputs.destination-group == 'mock-prod' ) }}
    needs: mock-staging
    runs-on: ubuntu-latest
    strategy:
      matrix:
        group: [mock-prod]
        dest: [in-cluster]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: "${{ inputs.revision-to-deploy }}"
      - uses: ./.github/actions/alveus-deploy
        with:
          target-revision: ${{ github.sha }}
          application-file: "./.alveus/applications/podinfo-${{ matrix.group }}-${{ matrix.dest }}.yaml"
          git-commit-msg: |
            deploy(${{ matrix.group }}): ðŸš€ to ${{ matrix.dest }}
