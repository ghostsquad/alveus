name: alveus
"on":
  workflow_call:
    inputs:
      destination-group:
        description: the destination group to deploy
        required: true
        type: string
      target-revision:
        description: the revision to deploy
        required: true
        type: string
      alveus-file:
        description: alveus file containing deployment metadata
        type: string
        required: true
      argocd-server-default:
        description: ARGOCD_SERVER environment variable
        type: string
        required: true
      argocd-opts:
        description: ARGOCD_OPTS environment variable
        type: string
        default: --grpc-web --insecure
      demo-mode:
        description: enable demo-mode, which runs KIND and installs to that
        type: boolean

defaults:
  run:
    shell: bash

env:
  ARGOCD_SERVER: ${{ inputs.argocd-server-default }}
  ARGOCD_OPTS: ${{ inputs.argocd-opts }}

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    outputs:
      matrix-data: ${{ steps.app-update.outputs.matrix-data }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
      - uses: ./.github/actions/app-update
        id: app-update
        with:
          alveus-file: ${{ inputs.alveus-file }}
          destination-group: ${{ inputs.destination-group }}
          target-revision: ${{ inputs.target-revision }}
          commit-message: |-
            deploy(mock-staging): ðŸš€ to ${{ matrix.dest }}

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy
    strategy:
      matrix:
        destination: ${{ fromJSON(needs.pre-deploy.outputs.matrix-data)  }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          ref: ${{ github.head_ref }}
          # required to commit changes back to the same repo
          persist-credentials: true
      # resolve specifics from destination vs input defaults
      - run: |-
          matrix_data=$(cat <<EOF
          ${{ needs.pre-deploy.outputs.matrix-data }}
          EOF
          )

          echo "::group::DEBUG needs.pre-deploy.outputs.matrix-data>"
          echo "${matrix_data}"
          echo "::endgroup::"
      - uses: ./.github/actions/setup-demo
        id: setup-demo
        if: inputs.demo-mode
      - uses: ./.github/actions/app-sync
        with:
          argocd-server-url: ${{ inputs.demo-mode && 'http://localhost:8080' || format('https://{0}', inputs.argocd-server-default) }}
          application-file: ${{ matrix.destination.applicationFile }}
          port-forward-log: ${{ steps.setup-demo.outputs.port-forward-log }}
